<!DOCTYPE html>
<html>
<head>
  <title>RealWar.io</title>
  <style>
    body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; }
    canvas { display: block; border: 5px solid white; }
    #scoreboard {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 10px;
      border-radius: 6px;
    }
    #deathMessage, #winMessage {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: bold;
      display: none;
      padding: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
    }
    #replayBtn {
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      padding: 10px 20px;
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="scoreboard"></div>
  <div id="deathMessage">Vous êtes éliminé</div>
  <div id="winMessage">Victoire !</div>
  <button id="replayBtn" onclick="location.reload()">Rejouer</button>

  <audio id="bloop" src="/sounds/bloop.mp3"></audio>
  <audio id="death" src="/sounds/death.mp3"></audio>
  <audio id="laser" src="/sounds/laser.mp3"></audio>
  <audio id="toc" src="/sounds/toc.mp3"></audio>
  <audio id="music" src="/sounds/western.mp3" autoplay loop></audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    canvas.width = 1920;
    canvas.height = 960;

    const socket = io();

    let playerId = null;
    let players = {};
    let bonuses = [];
    let walls = [];
    let mines = [];
    let eliminated = false;

    const bloop = document.getElementById("bloop");
    const death = document.getElementById("death");
    const laser = document.getElementById("laser");
    const toc = document.getElementById("toc");

    socket.on("askPassword", () => {
      const pw = prompt("Mot de passe :");
      socket.emit("checkPassword", pw);
    });

    socket.on("askName", () => {
      const name = prompt("Entrez votre pseudo :") || "Joueur";
      socket.emit("setName", name);
    });

    socket.on("init", (data) => {
      playerId = data.id;
      players = data.players;
      bonuses = data.bonuses;
      walls = data.walls;
    });

    socket.on("newPlayer", (p) => { players[p.id] = p });
    socket.on("removePlayer", (id) => { delete players[id] });

    socket.on("state", (state) => {
      players = state.players;
      bonuses = state.bonuses;
      walls = state.walls;
      mines = state.mines || [];
    });

    socket.on("bloop", () => bloop.play());
    socket.on("death", () => death.play());
    socket.on("hit", () => toc.play());
    socket.on("laser", () => laser.play());

    socket.on("dead", () => {
      eliminated = true;
      document.getElementById("deathMessage").style.display = "block";
      document.getElementById("replayBtn").style.display = "block";
    });

    socket.on("win", (winner) => {
      document.getElementById("winMessage").textContent = winner + " a gagné !";
      document.getElementById("winMessage").style.display = "block";
      document.getElementById("replayBtn").style.display = "block";
    });

    canvas.addEventListener("click", (e) => {
      if (eliminated) return;
      const rect = canvas.getBoundingClientRect();
      socket.emit("clickMove", {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      });
    });

    window.addEventListener("keydown", (e) => {
      if (eliminated) return;
      if (e.code === "Space") socket.emit("placeMine");
    });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.strokeStyle = "white";
      ctx.lineWidth = 5;
      ctx.strokeRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "#777";
      for (const w of walls) ctx.fillRect(w.x, w.y, w.w, w.h);

      for (const b of bonuses) {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 10, 0, Math.PI * 2);
        ctx.fillStyle = b.type === 'red' ? "red" : b.type === 'blue' ? "blue" : "green";
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("+" + b.amount, b.x, b.y + 3);
      }

      for (const m of mines) {
        const color = players[m.owner]?.color || "gray";
        ctx.fillStyle = color;
        ctx.fillRect(m.x - 5, m.y - 5, 10, 10);
      }

      for (const id in players) {
        const p = players[id];
        if (p.dead) continue;
        const r = 10 * (1 + p.units * 0.001);
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(p.name, p.x, p.y - r - 6);
        ctx.fillText(p.units + " u.", p.x, p.y + 4);
      }

      let ranking = Object.values(players).sort((a, b) => b.score - a.score);
      document.getElementById("scoreboard").innerHTML = ranking.map(p => `${p.name}: ${p.score}`).join("<br>");

      requestAnimationFrame(draw);
    }
    draw();
  </script>
</body>
</html>

